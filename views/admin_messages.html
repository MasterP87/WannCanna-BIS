<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin – Nachrichten</title>
  <link rel="stylesheet" href="/static/css/style.css"/>
</head>
<body>
<header>
  <div class="brand">
    <img class="logo" src="/static/img/logo.png" alt="WannCannaBis Logo"/>
    <span class="brand-name">WannCannaBis</span>
  </div>
  <nav>
    <a href="/">Start</a>
    <a href="/admin/keys">Schlüssel</a>
    <a href="/admin/sellers">Verkäufer</a>
    <a href="/admin/buyers">Käufer</a>
    <a href="/admin/messages">Nachrichten</a>
    <a href="/admin/advert">Werbung</a>
    <a href="/admin/backup/users">Backup</a>
    <a href="/admin/logout">Logout</a>
  </nav>
</header>
<main>
  <div class="container">
    <h1>Nachrichten</h1>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>Von</th><th>An</th><th>Nachricht</th><th>Datum</th></tr>
        </thead>
        <tbody id="msgRows"></tbody>
      </table>
    </div>
    <h3 class="mt-3">Neue Nachricht senden</h3>
    <form method="post" action="/admin/messages/send" class="row">
      <select name="to" required>
        <option value="all">Alle Benutzer</option>
        <option value="buyers">Alle Käufer</option>
        <option value="sellers">Alle Verkäufer</option>
      </select>
      <textarea name="message" rows="3" placeholder="Ihre Nachricht" required></textarea>
      <button type="submit" class="btn btn-accent">Senden</button>
    </form>
    <p class="helper">Um eine Nachricht an einen einzelnen Nutzer zu senden, wählen Sie diesen im Dropdown oben aus.</p>
  </div>
</main>
<script>
var messages = JSON.parse('{{{messages}}}'.replace(/&quot;/g,'"'));
var users = JSON.parse('{{{users}}}'.replace(/&quot;/g,'"'));
// Populate select with individual users
var select = document.querySelector('select[name="to"]');
users.forEach(function(u){
  var opt = document.createElement('option');
  opt.value = u.id;
  opt.textContent = (u.type === 'buyer' ? 'Käufer: ' : 'Verkäufer: ') + u.name + ' (' + u.email + ')';
  select.appendChild(opt);
});
function fmt(ts) {
  try {
    return new Intl.DateTimeFormat(undefined, { dateStyle:'medium', timeStyle:'short' }).format(new Date(ts));
  } catch (e) { return ts; }
}
var tbody = document.getElementById('msgRows');
messages.forEach(function(m){
  var fromLabel = m.from === 'admin' ? 'Admin' : (users.find(u=>u.id===m.from)||{}).name || m.from;
  var toLabel;
  if(m.to === 'all'){ toLabel = 'Alle'; }
  else if(m.to === 'buyers'){ toLabel = 'Alle Käufer'; }
  else if(m.to === 'sellers'){ toLabel = 'Alle Verkäufer'; }
  else { var u = users.find(u=>u.id===m.to)||{}; toLabel = u.name || m.to; }
  var tr = document.createElement('tr');
  tr.innerHTML = '<td>'+fromLabel+'</td><td>'+toLabel+'</td><td>'+m.body+'</td><td>'+fmt(m.createdAt)+'</td>';
  tbody.appendChild(tr);
});
</script>
<footer>© WannCannaBis</footer>
</body>
</html>