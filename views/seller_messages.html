<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Nachrichten – Verkäufer</title>
  <link rel="stylesheet" href="/static/css/style.css"/>
</head>
<body>
<header>
  <div class="brand">
    <img class="logo" src="/static/img/logo.png" alt="WannCannaBis Logo"/>
    <span class="brand-name">WannCannaBis</span>
  </div>
  <nav>
    <a href="/">Start</a>
    <a href="/seller/dashboard">Dashboard</a>
    <a href="/seller/appointments/new">Neuer Termin</a>
    <a href="/seller/products">Produkte</a>
    <a href="/seller/buyers">Käufer</a>
    <a href="/seller/messages">Nachrichten</a>
    <a href="/seller/key">Freischaltcode</a>
    <a href="/logout">Abmelden</a>
  </nav>
</header>
<main>
  <div class="container">
    <h1>Nachrichten</h1>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>Von</th><th>An</th><th>Nachricht</th><th>Datum</th></tr>
        </thead>
        <tbody id="msgRows"></tbody>
      </table>
    </div>
    <h3 class="mt-3">Neue Nachricht senden</h3>
    <form method="post" action="/seller/messages" class="row">
      <select name="to" required>
        <option value="all">Alle freigeschalteten Käufer</option>
      </select>
      <textarea name="message" rows="3" placeholder="Ihre Nachricht" required></textarea>
      <button type="submit" class="btn btn-accent">Senden</button>
    </form>
  </div>
</main>
<script>
// Embedded data from server
var messages = JSON.parse('{{{messages}}}'.replace(/&quot;/g, '"'));
var buyers = JSON.parse('{{{buyers}}}'.replace(/&quot;/g, '"'));
var userId = null;
// Determine current seller ID from first message if available (for display)
// We don't embed seller ID separately; the server will not require it.
// Populate recipient dropdown with approved buyers
var sel = document.querySelector('select[name="to"]');
buyers.forEach(function(b) {
  var opt = document.createElement('option');
  opt.value = b.id;
  opt.textContent = b.name + ' (' + b.email + ')';
  sel.appendChild(opt);
});
// Render messages table
function fmt(ts) {
  try {
    return new Intl.DateTimeFormat(undefined, { dateStyle: 'medium', timeStyle: 'short' }).format(new Date(ts));
  } catch (e) {
    return ts;
  }
}
var tbody = document.getElementById('msgRows');
messages.forEach(function(m) {
  var tr = document.createElement('tr');
  var fromLabel;
  if (m.from === 'admin') {
    fromLabel = 'Admin';
  } else {
    var fromUser = buyers.find(b => b.id === m.from) || {};
    // fallback to ID
    fromLabel = fromUser.name || m.from;
  }
  var toLabel;
  if (m.to === 'all') {
    toLabel = 'Alle';
  } else {
    var toUser = buyers.find(b => b.id === m.to) || {};
    toLabel = toUser.name || m.to;
  }
  tr.innerHTML = '<td>' + fromLabel + '</td>' +
                 '<td>' + toLabel + '</td>' +
                 '<td>' + m.body + '</td>' +
                 '<td>' + fmt(m.createdAt) + '</td>';
  tbody.appendChild(tr);
});
</script>
<footer>© WannCannaBis</footer>
</body>
</html>